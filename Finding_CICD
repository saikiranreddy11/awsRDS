#!/bin/bash

# Subgroup ID
subgroup_id=15232830  # Replace with your actual subgroup ID

# Fetch all projects in the subgroup
projects=$(curl --silent --header "PRIVATE-TOKEN: glpat-JPXQyL_BUaMJMAKJNwoQ" "https://gitlab.com/api/v4/groups/$subgroup_id/projects?per_page=100")

# Loop through each project and check if .gitlab-ci.yml exists in the default branch
IFS=$'\n'  # Set IFS to handle newline, preserving spaces in project names
echo "$projects" | jq -r '.[] | "\(.id) \(.name) \(.default_branch)"' | while IFS= read -r line; do
  project_id=$(echo "$line" | awk '{print $1}')
  project_name=$(echo "$line" | cut -d' ' -f2- | rev | cut -d' ' -f2- | rev)  # Extract project name while handling spaces
  default_branch=$(echo "$line" | awk '{print $NF}')
  
  echo "Checking project: $project_name (ID: $project_id, Default Branch: $default_branch)"
  
  # Skip if there's no default branch (possible empty or unconfigured repo)
  if [ "$default_branch" = "null" ]; then
    echo "Project: $project_name (ID: $project_id) does NOT have a default branch or CI/CD pipeline"
    continue
  fi
  
  # Check for .gitlab-ci.yml file in the default branch
  response=$(curl --silent --header "PRIVATE-TOKEN: glpat-JPXQyL_BUaMJMAKJNwoQ" "https://gitlab.com/api/v4/projects/$project_id/repository/files/.gitlab-ci.yml?ref=$default_branch")

  if [[ "$response" == *"404"* ]]; then
    echo "Project: $project_name: No pipeline"
  else
    echo "Project: $project_name: Has pipeline"
  fi
done
