#!/bin/bash

# Subgroup ID
subgroup_id=15232830  # Replace with your actual subgroup ID

# Fetch all projects in the subgroup
projects=$(curl --silent --header "PRIVATE-TOKEN: glpat-JPXQyL_BUaMJMAKJNwoQ" "https://gitlab.com/api/v4/groups/$subgroup_id/projects?per_page=100")

# Loop through each project and check if .gitlab-ci.yml exists in the default branch
echo "$projects" | jq -r '.[] | "\(.id) \(.name) \(.default_branch)"' | while read project_id project_name default_branch; do
  echo "Checking project: $project_name (ID: $project_id, Default Branch: $default_branch)"
  
  # Skip if there's no default branch (possible empty or unconfigured repo)
  if [ "$default_branch" = "null" ]; then
    echo "Project: $project_name (ID: $project_id) does NOT have a default branch or CI/CD pipeline"
    continue
  fi
  
  # Check for .gitlab-ci.yml file in the default branch by capturing the HTTP status code
  status_code=$(curl --silent --output /dev/null --write-out "%{http_code}" --header "PRIVATE-TOKEN: glpat-JPXQyL_BUaMJMAKJNwoQ" "https://gitlab.com/api/v4/projects/$project_id/repository/files/.gitlab-ci.yml?ref=$default_branch")

  if [ "$status_code" -eq 404 ]; then
    echo "Project: $project_name (ID: $project_id) does NOT have a CI/CD pipeline"
  elif [ "$status_code" -eq 200 ]; then
    echo "Project: $project_name (ID: $project_id) has a CI/CD pipeline"
  else
    echo "Project: $project_name (ID: $project_id) returned an unexpected status code: $status_code"
  fi
done
