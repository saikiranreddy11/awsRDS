import requests
import csv

# GitLab API settings
GITLAB_API_URL = "https://gitlab.com/api/v4"
PRIVATE_TOKEN = "YOUR_ACCESS_TOKEN"  # Replace with your GitLab private token
GROUP_ID = "YOUR_GROUP_ID"  # Replace with the group ID for which you want to fetch members

# Headers for the GitLab API
headers = {
    "PRIVATE-TOKEN": PRIVATE_TOKEN
}

def get_group_members(group_id, members=[]):
    """Fetch all members of a group including subgroups, and return a list of members with their access levels."""
    page = 1
    per_page = 100
    while True:
        url = f"{GITLAB_API_URL}/groups/{group_id}/members/all?per_page={per_page}&page={page}"
        response = requests.get(url, headers=headers)
        if response.status_code != 200:
            print(f"Error fetching group members: {response.status_code}")
            break

        data = response.json()
        if not data:
            break

        for member in data:
            members.append({
                "name": member.get("name"),
                "username": member.get("username"),
                "group_id": group_id,
                "access_level": member.get("access_level")
            })

        page += 1

    return members

def get_subgroup_projects(group_id):
    """Fetch all subgroups and projects within the group recursively."""
    projects = []
    subgroups = []
    # Fetch subgroups
    url = f"{GITLAB_API_URL}/groups/{group_id}/subgroups"
    response = requests.get(url, headers=headers)
    if response.status_code == 200:
        subgroups = response.json()

    # Fetch projects
    url = f"{GITLAB_API_URL}/groups/{group_id}/projects"
    response = requests.get(url, headers=headers)
    if response.status_code == 200:
        projects = response.json()

    return subgroups, projects

def export_to_csv(members, filename="gitlab_members.csv"):
    """Export the list of members to a CSV file."""
    with open(filename, mode="w", newline="") as file:
        writer = csv.DictWriter(file, fieldnames=["name", "username", "group_id", "access_level"])
        writer.writeheader()
        for member in members:
            writer.writerow(member)

def main():
    all_members = []

    # Get members for the main group
    print(f"Fetching members for group ID: {GROUP_ID}")
    all_members = get_group_members(GROUP_ID)

    # Get subgroups and projects recursively
    subgroups, projects = get_subgroup_projects(GROUP_ID)

    # Fetch members for subgroups
    for subgroup in subgroups:
        print(f"Fetching members for subgroup: {subgroup['name']} (ID: {subgroup['id']})")
        all_members += get_group_members(subgroup["id"])

    # Fetch members for each project
    for project in projects:
        print(f"Fetching members for project: {project['name']} (ID: {project['id']})")
        url = f"{GITLAB_API_URL}/projects/{project['id']}/members"
        response = requests.get(url, headers=headers)
        if response.status_code == 200:
            project_members = response.json()
            for member in project_members:
                all_members.append({
                    "name": member.get("name"),
                    "username": member.get("username"),
                    "group_id": project['id'],
                    "access_level": member.get("access_level")
                })

    # Export all members to CSV
    print("Exporting members to CSV...")
    export_to_csv(all_members)

if __name__ == "__main__":
    main()










import requests
import csv

# Replace with your actual GitLab access token and parent subgroup ID
PRIVATE_TOKEN = 'your_private_token'
PARENT_SUBGROUP_ID = 'your_parent_subgroup_id'
GITLAB_URL = 'https://gitlab.com/api/v4'

# Headers for API requests
headers = {'PRIVATE-TOKEN': PRIVATE_TOKEN}

# Function to get all subgroups and projects under a parent subgroup
def get_subgroups_and_projects(subgroup_id):
    all_resources = []
    page = 1
    per_page = 100
    
    # Get subgroups recursively
    while True:
        response = requests.get(f'{GITLAB_URL}/groups/{subgroup_id}/subgroups', headers=headers, params={'per_page': per_page, 'page': page})
        
        try:
            subgroups = response.json()
        except ValueError:
            print(f"Error parsing JSON for subgroups in subgroup ID: {subgroup_id}")
            print(response.text)
            break

        if not subgroups:
            break
        
        for subgroup in subgroups:
            all_resources.append({'id': subgroup['id'], 'name': subgroup['name'], 'path': subgroup['full_path'], 'type': 'subgroup'})
            all_resources += get_subgroups_and_projects(subgroup['id'])  # Recursive call to get sub-subgroups and projects
            
        page += 1

    # Get projects in this subgroup
    page = 1
    while True:
        response = requests.get(f'{GITLAB_URL}/groups/{subgroup_id}/projects', headers=headers, params={'per_page': per_page, 'page': page})
        
        try:
            projects = response.json()
        except ValueError:
            print(f"Error parsing JSON for projects in subgroup ID: {subgroup_id}")
            print(response.text)
            break

        if not projects:
            break
        
        for project in projects:
            all_resources.append({'id': project['id'], 'name': project['name'], 'path': project['path_with_namespace'], 'type': 'project'})
        
        page += 1

    return all_resources

# Function to get members of a subgroup or project
def get_members(resource_id, resource_type):
    page = 1
    per_page = 100
    members = []

    endpoint = f'{GITLAB_URL}/{resource_type}s/{resource_id}/members/all'
    
    while True:
        response = requests.get(endpoint, headers=headers, params={'per_page': per_page, 'page': page})
        
        try:
            resource_members = response.json()
        except ValueError:
            print(f"Error parsing JSON for members in {resource_type} ID: {resource_id}")
            print(response.text)
            break
        
        if not isinstance(resource_members, list):
            print(f"Unexpected response format for {resource_type} ID: {resource_id}")
            break

        for member in resource_members:
            members.append({
                'name': member.get('name', 'Unknown'),
                'username': member.get('username', 'Unknown'),
                'access_level': member.get('access_level', 'Unknown'),
            })
        
        page += 1
        if len(resource_members) < per_page:
            break  # Stop if fewer than 'per_page' results are returned

    return members

# Function to create a CSV file for the output
def write_to_csv(member_access):
    with open('member_access.csv', 'w', newline='') as csvfile:
        fieldnames = ['Member Name', 'Member Username', 'Resource Path', 'Access Level']
        writer = csv.DictWriter(csvfile, fieldnames=fieldnames)
        writer.writeheader()
        
        # Loop through the unique_members dictionary where the key is a tuple (name, username)
        for (member_name, member_username), resources in member_access.items():
            for resource in resources:
                writer.writerow({
                    'Member Name': member_name,
                    'Member Username': member_username,
                    'Resource Path': resource['path'],
                    'Access Level': resource['access_level']
                })

# Main function to gather all the data
def main():
    print("Fetching all subgroups and projects...")
    resources = get_subgroups_and_projects(PARENT_SUBGROUP_ID)
    
    unique_members = {}
    
    print("Fetching members for each subgroup and project...")
    for resource in resources:
        resource_members = get_members(resource['id'], resource['type'])
        
        for member in resource_members:
            member_key = (member['name'], member['username'])
            if member_key not in unique_members:
                unique_members[member_key] = []
            
            unique_members[member_key].append({
                'path': resource['path'],
                'access_level': member['access_level']
            })
    
    print(f"Found {len(unique_members)} unique members.")
    
    print("Writing data to CSV...")
    write_to_csv(unique_members)
    print("Done! Output written to 'member_access.csv'")

if __name__ == '__main__':
    main()

















import requests
import csv

# Replace with your actual GitLab access token and parent subgroup ID
PRIVATE_TOKEN = 'your_private_token'
PARENT_SUBGROUP_ID = 'your_parent_subgroup_id'
GITLAB_URL = 'https://gitlab.com/api/v4'

# Headers for API requests
headers = {'PRIVATE-TOKEN': PRIVATE_TOKEN}

# Function to get all subgroups and projects under a parent subgroup
def get_subgroups_and_projects(subgroup_id):
    all_resources = []
    page = 1
    per_page = 100
    
    # Get subgroups recursively
    while True:
        response = requests.get(f'{GITLAB_URL}/groups/{subgroup_id}/subgroups', headers=headers, params={'per_page': per_page, 'page': page})
        
        try:
            subgroups = response.json()
        except ValueError:
            print(f"Error parsing JSON for subgroups in subgroup ID: {subgroup_id}")
            print(response.text)
            print(response.headers)
            break

        if not subgroups:
            print(f"Unexpected response format for subgroup ID: {subgroup_id}")
            print(response.text)
            print(response.headers)
            break
        
        for subgroup in subgroups:
            all_resources.append({'id': subgroup['id'], 'name': subgroup['name'], 'path': subgroup['full_path'], 'type': 'subgroup'})
            all_resources += get_subgroups_and_projects(subgroup['id'])  # Recursive call to get sub-subgroups and projects
            
        page += 1

    # Get projects in this subgroup
    page = 1
    while True:
        response = requests.get(f'{GITLAB_URL}/groups/{subgroup_id}/projects', headers=headers, params={'per_page': per_page, 'page': page})
        
        try:
            projects = response.json()
        except ValueError:
            print(f"Error parsing JSON for projects in subgroup ID: {subgroup_id}")
            print(response.text)
            print(response.headers)
            break

        if not projects:
            break
        
        for project in projects:
            all_resources.append({'id': project['id'], 'name': project['name'], 'path': project['path_with_namespace'], 'type': 'project'})
        
        page += 1

    return all_resources

# Function to get members of a subgroup or project
def get_members(resource_id, resource_type):
    page = 1
    per_page = 100
    members = []

    endpoint = f'{GITLAB_URL}/{resource_type}s/{resource_id}/members/all'
    
    while True:
        response = requests.get(endpoint, headers=headers, params={'per_page': per_page, 'page': page})
        
        try:
            resource_members = response.json()
        except ValueError:
            print(f"Error parsing JSON for members in {resource_type} ID: {resource_id}")
            print(response.text)
            print(response.headers)
            break
        
        if not isinstance(resource_members, list):
            print(f"Unexpected response format for {resource_type} ID: {resource_id}")
            print(response.text)
            print(response.headers)
            break

        for member in resource_members:
            members.append({
                'name': member.get('name', 'Unknown'),
                'username': member.get('username', 'Unknown'),
                'access_level': member.get('access_level', 'Unknown'),
            })
        
        page += 1
        if len(resource_members) < per_page:
            break  # Stop if fewer than 'per_page' results are returned

    return members

# Function to create a CSV file for the output
def write_to_csv(member_access, filename='member_access.csv'):
    with open(filename, 'w', newline='') as csvfile:
        fieldnames = ['Member Name', 'Member Username', 'Resource Path', 'Access Level']
        writer = csv.DictWriter(csvfile, fieldnames=fieldnames)
        writer.writeheader()
        
        # Loop through the unique_members dictionary where the key is a tuple (name, username)
        for (member_name, member_username), resources in member_access.items():
            for resource in resources:
                writer.writerow({
                    'Member Name': member_name,
                    'Member Username': member_username,
                    'Resource Path': resource['path'],
                    'Access Level': resource['access_level']
                })

# Function to create a CSV of unique members
def write_unique_members_to_csv(member_access, filename='unique_members.csv'):
    unique_users = set()

    # Extract the unique names and usernames
    for (member_name, member_username), _ in member_access.items():
        unique_users.add((member_name, member_username))

    with open(filename, 'w', newline='') as csvfile:
        fieldnames = ['Member Name', 'Member Username']
        writer = csv.DictWriter(csvfile, fieldnames=fieldnames)
        writer.writeheader()

        for member_name, member_username in unique_users:
            writer.writerow({
                'Member Name': member_name,
                'Member Username': member_username
            })

# Main function to gather all the data
def main():
    print("Fetching all subgroups and projects...")
    resources = get_subgroups_and_projects(PARENT_SUBGROUP_ID)
    
    unique_members = {}
    
    print("Fetching members for each subgroup and project...")
    for resource in resources:
        resource_members = get_members(resource['id'], resource['type'])
        
        for member in resource_members:
            member_key = (member['name'], member['username'])
            if member_key not in unique_members:
                unique_members[member_key] = []
            
            unique_members[member_key].append({
                'path': resource['path'],
                'access_level': member['access_level']
            })
    
    print(f"Found {len(unique_members)} unique members.")
    
    # Write the main member access data
    print("Writing data to 'member_access.csv'...")
    write_to_csv(unique_members, filename='member_access.csv')

    # Write unique users data
    print("Writing unique members to 'unique_members.csv'...")
    write_unique_members_to_csv(unique_members)

    print("Done! Outputs written to 'member_access.csv' and 'unique_members.csv'")

if __name__ == '__main__':
    main()


    print("Done! Output written to 'member_access.csv'")

if __name__ == '__main__':
    main()
