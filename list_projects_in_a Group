import gitlab
import csv

# Replace with your GitLab private token
PRIVATE_TOKEN = 'your_private_token'

# GitLab server URL
GITLAB_URL = 'https://gitlab.com'

# Parent group ID (replace this with your parent group ID)
PARENT_GROUP_ID = 'your_parent_group_id'

# Initialize GitLab connection
gl = gitlab.Gitlab(GITLAB_URL, private_token=PRIVATE_TOKEN)
gl.auth()

# Recursive function to fetch all projects in the group and subgroups
def get_all_projects_in_group(group_id, all_projects=[]):
    # Fetch group information
    group = gl.groups.get(group_id)

    # Fetch projects in the current group
    projects = group.projects.list(all=True)
    for project in projects:
        all_projects.append({
            'id': project.id,
            'name': project.name,
            'path': project.path_with_namespace,
            'web_url': project.web_url,
        })

    # Fetch subgroups and recursively fetch their projects
    subgroups = group.subgroups.list(all=True)
    for subgroup in subgroups:
        get_all_projects_in_group(subgroup.id, all_projects)

    return all_projects

# Write projects to CSV
def write_projects_to_csv(projects, filename='projects_list.csv'):
    with open(filename, mode='w', newline='', encoding='utf-8') as csv_file:
        fieldnames = ['ID', 'Name', 'Path', 'URL']
        writer = csv.DictWriter(csv_file, fieldnames=fieldnames)
        
        writer.writeheader()
        for project in projects:
            writer.writerow({
                'ID': project['id'],
                'Name': project['name'],
                'Path': project['path'],
                'URL': project['web_url'],
            })

    print(f"Projects data successfully written to {filename}")

# Main function
def main():
    print(f"Fetching all projects for group ID: {PARENT_GROUP_ID}")
    all_projects = get_all_projects_in_group(PARENT_GROUP_ID)

    if not all_projects:
        print("No projects found.")
        return

    print(f"Found {len(all_projects)} projects.")
    
    # Write the project data to CSV
    write_projects_to_csv(all_projects)

if __name__ == '__main__':
    main()
