#!/bin/bash

# Replace with your GitHub token and organization name
TOKEN="ghp_IfMbwtyTeKGomsCXiEbNBRDFOMtkCRoUxk0D"
ORG="QDXEnterpriseOrg"

# Initialize page number
PAGE=1

# Loop until no more repositories are returned
while true; do
  echo "Fetching page $PAGE..."

  # Fetch repositories for the current page
  RESPONSE=$(curl -s -H "Authorization: token $TOKEN" \
    "https://api.github.com/orgs/$ORG/repos?per_page=100&page=$PAGE")

  # Check if the response is valid JSON
  if ! echo "$RESPONSE" | jq empty 2>/dev/null; then
    echo "Error: Response is not valid JSON or API error."
    echo "Response: $RESPONSE"
    break
  fi

  # Check if the response is empty
  if [[ -z "$RESPONSE" || "$RESPONSE" == "[]" ]]; then
    echo "No more repositories found or empty response."
    break
  fi

  # Filter and print repository names that start with "dso-htasdatagroup-"
  MATCHING_REPOS=$(echo "$RESPONSE" | jq -r '.[] | select(.name | startswith("dso-htasdatagroup-")) | .name')
  
  if [[ -n "$MATCHING_REPOS" ]]; then
    echo "Repositories matching 'dso-htasdatagroup-' on page $PAGE:"
    echo "$MATCHING_REPOS"
  else
    echo "No repositories matching 'dso-htasdatagroup-' found on page $PAGE."
  fi

  # Check if the number of repositories returned is less than 100
  REPO_COUNT=$(echo "$RESPONSE" | jq '. | length')
  if [[ $REPO_COUNT -lt 100 ]]; then
    echo "Fetched the last page of repositories."
    break
  fi

  # Increment page number
  ((PAGE++))
done
