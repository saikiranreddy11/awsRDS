name: "Terraform Provisioner"

on:
  workflow_dispatch:
    inputs:
      environment:
        description: "Select environment"
        required: true
        type: choice
        options:
          - dev
          - qa
          - prd
      resource:
        description: "Select resource to deploy"
        required: true
        type: choice
        options:
          - compute
          - ecr
          - ecs-fargate/ecs-cluster
          - ecs-fargate/prism
          - ecs-fargate/event-horizon
          - ecs-fargate/redis
          - ecs-fargate/queue-worker-1
          - ecs-fargate/queue-worker-2
          - iam

jobs:
  tf_plan:
    uses: ./.github/workflows/terraform-plan.yml
    permissions:
      id-token: write
      contents: read
    with:
      environment: ${{ github.event.inputs.environment }}
      tf_root_suffix: ${{ github.event.inputs.resource }}
      wiz_enabled: false
    secrets: inherit

  tf_approval:
    needs: tf_plan
    name: Terraform Approval for ${{ github.event.inputs.resource }} in ${{ github.event.inputs.environment }}
    runs-on: arc-rs-nonprod
    environment: tf-approval
    steps:
      - name: Wait for manual approval
        run: echo "Waiting for approval..."

  tf_apply:
    needs: tf_approval
    uses: ./.github/workflows/terraform-apply.yml
    permissions: write-all
    with:
      environment: ${{ github.event.inputs.environment }}
      tf_root_suffix: ${{ github.event.inputs.resource }}
    secrets: inherit
