- name: Wait for ECS Deployment
  run: |
    CLUSTER_NAME="dgx-prism-use1-prd-ecs"
    SERVICE_NAME="${{ matrix.service }}"
    MAX_WAIT_TIME=600  # 10 minutes timeout
    TIME_ELAPSED=0

    while true; do
      STATUS=$(aws ecs describe-services --cluster $CLUSTER_NAME --services $SERVICE_NAME --query "services[0].deployments[0].rolloutState" --output text)

      if [ "$STATUS" == "COMPLETED" ]; then
        echo "✅ Deployment (or rollback) completed successfully"
        break
      elif [ "$STATUS" == "FAILED" ]; then
        echo "⚠️ Deployment failed! Waiting for rollback to complete..."
        
        # Wait for rollback to complete
        while true; do
          ROLLBACK_STATUS=$(aws ecs describe-services --cluster $CLUSTER_NAME --services $SERVICE_NAME --query "services[0].deployments[0].rolloutState" --output text)
          
          if [ "$ROLLBACK_STATUS" == "COMPLETED" ]; then
            echo "✅ Rollback completed successfully"
            exit 1  # Mark the pipeline as failed after rollback
          fi

          if [ "$TIME_ELAPSED" -ge "$MAX_WAIT_TIME" ]; then
            echo "❌ Rollback taking too long! Manual intervention required."
            exit 1
          fi

          echo "⏳ Rollback in progress..."
          sleep 15
          TIME_ELAPSED=$((TIME_ELAPSED + 15))
        done
      else
        echo "⏳ Waiting for deployment to complete..."
      fi

      sleep 15
      TIME_ELAPSED=$((TIME_ELAPSED + 15))

      if [ "$TIME_ELAPSED" -ge "$MAX_WAIT_TIME" ]; then
        echo "❌ Deployment taking too long! Manual intervention required."
        exit 1
      fi
    done
