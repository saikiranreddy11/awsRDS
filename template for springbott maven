on:
  workflow_dispatch:
    inputs:
      branch:
        description: 'Branch to Deploy'
        required: true
      commit_sha:
        description: 'Commit SHA to deploy'
        required: true
      environment:
        description: 'Select the Environment to Deploy'
        type: choice
        options:
          - dev
          - qa
          - staging
          - prod
        required: true
      dry_run:
        description: 'Enable Dry-Run Mode?'
        type: boolean
        required: false
        default: false



- name: Deploy to Kubernetes using Helm
  env:
    ECR_REPOSITORY: ${{ steps.artifact_info.outputs.ecr_repo }}
    IMAGE_TAG: ${{ steps.artifact_info.outputs.image_tag }}
    NAMESPACE: ${{ inputs.environment }}  # Dynamic Namespace
  run: |
    echo "Deploying image: $ECR_REPOSITORY:$IMAGE_TAG to namespace $NAMESPACE"

    # Check if dry-run mode is enabled
    if [[ "${{ inputs.dry_run }}" == "true" ]]; then
      DRY_RUN_FLAGS="--dry-run --debug"
      echo "Running in Dry-Run Mode..."
    else
      DRY_RUN_FLAGS=""
    fi

    # Run Helm with or without dry-run
    helm upgrade --install my-app ./charts \
      --namespace $NAMESPACE \
      --set image.tag=$IMAGE_TAG \
      --set image.repository=$ECR_REPOSITORY \
      $DRY_RUN_FLAGS
